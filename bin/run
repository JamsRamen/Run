#!/bin/bash

RUN_DIR="$(realpath "$0" | xargs dirname | xargs dirname)"
HELP="View help with 'run help'."

if [[ $# -lt 1 ]]
then
    printf "No arguments provided. %s" "$HELP"
    exit 1
fi

if [[ "$1" == *.* ]]
then
    TARGET="$1"
    RULE="${TARGET##*.}"
else
    RULE="$1"
    if [[ $# -ge 2 ]]
    then
        TARGET="$2"
    else
        TARGET=""
    fi
fi

if [[ "" != "$TARGET" ]]
then
    TARGET="$(realpath "$TARGET")"
    
    if [[ ! -f "$TARGET" && ! -d "$TARGET" ]]
    then
        printf "Target '%s' not found." "$TARGET"
        exit 1
    fi
fi
   
if [[ ! -f "$RUN_DIR/rule/$RULE" ]]
then
    printf "Rule '%s' not found." "$RULE"
    exit 1
fi

"$RUN_DIR/util/run_rule" "$RUN_DIR" "$RULE" "${TARGET%.*}" <&0 || exit $?
