#!/bin/bash

# $1 = run_dir
# $2 = rule
# $3 = target

SKIP=false

while IFS="" read -r CMD <&3 || [[ -n "$CMD" ]]
do
    CMD=${CMD//@@/$1}
    CMD=${CMD//@/$3}
    
    CMD_TYPE="${CMD:0:1}"

    if [[ "$CMD_TYPE" == "$" ]]
    then
        if [[ "$SKIP" == false ]]
        then
            printf "%s\n" "$OBJ" >> "$1/dat/obj"
        fi

        SKIP=false
    fi

    if [[ "$CMD_TYPE" == "!" && "$SKIP" == false ]]
    then
        eval "${CMD:1}" || exit $?
    fi

    if [[ "$CMD_TYPE" == ">" ]]
    then
        read -ra FILE_ARR <<< "${CMD:1}"
        OBJ=${FILE_ARR[0]}
        PRE_ARRAY=${FILE_ARR[*]:1}

        NEED_COMPILE=false

        for PRE in ${PRE_ARRAY[*]}
        do
            if [[ ! -f "$PRE" ]]
            then
                printf "Prestiquite '%s' does not exist.\n" "$PRE"
                exit 1
            fi

            if [[ ! -f "$OBJ" || "$PRE" -nt "$OBJ" ]]
            then
                NEED_COMPILE=true
            fi
        done

        if [[ "$NEED_COMPILE" == false ]]
        then
            SKIP=true
        fi
    fi
done 3< "$1/rule/$2"